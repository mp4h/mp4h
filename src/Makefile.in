##
##  Makefile --  mp4h Makefile for main program
##

@SET_MAKE@
SHELL = /bin/sh

top_srcdir      = @top_srcdir@
top_builddir    = @top_srcdir@
srcdir          = @srcdir@
VPATH           = @srcdir@

prefix          = @prefix@
datadir         = @datadir@

# ------------------------------------------------
#   DEFINITIONS
# ------------------------------------------------

CONFIG_HEADER = ../config.h

CC      = @CC@
AR      = ar
RANLIB  = @RANLIB@

DEFS     = @DEFS@ -I. -I$(srcdir) -I..
CPPFLAGS = @CPPFLAGS@
LDFLAGS  = @LDFLAGS@ @WITH_MODULES_TRUE@ -export-dynamic
LIBTOOL  = @LIBTOOL@
INCLTDL  = @INCLTDL@
LIBLTDL  = @LIBLTDL@
INCLUDES = -I$(top_srcdir)/lib -I$(top_srcdir)/pcre $(INCLTDL)
LDADD    = $(LIBLTDL) ../lib/libmp4h.a ../pcre/libpcreposix.a ../pcre/libpcre.a
CFLAGS   = @CFLAGS@
COMPILE  = $(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS)
CCLD     = $(CC)
@WITH_MODULES_FALSE@LINK     = $(CCLD) $(CFLAGS) $(LDFLAGS) -o $@
@WITH_MODULES_TRUE@LINK     = $(LIBTOOL) --quiet --mode=link $(CCLD) $(CFLAGS) $(LDFLAGS) -o $@
LIBS     = @LIBS@ -lm

@WITH_MODULES_TRUE@MODULE_C = module.c
SOURCES = mp4h.c builtin.c debug.c devel.c freeze.c input.c \
    macro.c $(MODULE_C) output.c path.c symtab.c version.c

HEADERS = mp4h.h builtin.h
OBJECTS = $(SOURCES:.c=.o)

# ------------------------------------------------
#   COMPILATION RULES
# ------------------------------------------------

.SUFFIXES:
.SUFFIXES: .c .o
.c.o:
	@echo '$(COMPILE) -c $<'; \
	$(COMPILE) -c $<

# ------------------------------------------------
#   DEFAULT TARGET
# ------------------------------------------------

all: mp4h

mp4h: $(OBJECTS) $(LDADD)
	@rm -f $@
	$(LINK) $(OBJECTS) $(LDADD) $(LIBS)

../lib/libmp4h.a:
	cd ../lib && $(MAKE) libmp4h.a

../pcre/libpcre.a ../pcre/libpcreposix.a:
	cd ../pcre && $(MAKE) all

install:
	@:

# ------------------------------------------------
#   CLEANUP
# ------------------------------------------------

clean:
	-rm -f *.o mp4h core

distclean: clean
	-rm -f Makefile

# ------------------------------------------------
#   TEST SUITE
# ------------------------------------------------

check: all
	cd ../tests && $(MAKE) $@

test: check

# ------------------------------------------------
#   TEST SUITE
# ------------------------------------------------

depend:
	$(MAKE) clean
	$(MAKE) CPPFLAGS=-MM >> Makefile.in

mp4h.o: mp4h.c mp4h.h ../lib/obstack.h version.c
builtin.o: builtin.c mp4h.h ../lib/obstack.h builtin.h \
 ../pcre/pcreposix.h version.c
debug.o: debug.c mp4h.h ../lib/obstack.h
devel.o: devel.c mp4h.h ../lib/obstack.h
freeze.o: freeze.c mp4h.h ../lib/obstack.h
input.o: input.c mp4h.h ../lib/obstack.h
macro.o: macro.c mp4h.h ../lib/obstack.h
module.o: module.c mp4h.h ../lib/obstack.h builtin.h \
 ../pcre/pcreposix.h version.c ../libltdl/ltdl.h
output.o: output.c mp4h.h ../lib/obstack.h
path.o: path.c mp4h.h ../lib/obstack.h
symtab.o: symtab.c mp4h.h ../lib/obstack.h
version.o: version.c ../src/version.c

##EOF##
