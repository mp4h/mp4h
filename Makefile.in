##
##  Makefile -- mp4h Makefile
##

@SET_MAKE@
SHELL = /bin/sh

top_srcdir      = @top_srcdir@
srcdir          = @srcdir@
prefix          = @prefix@
exec_prefix     = @exec_prefix@
bindir          = @bindir@
mandir          = @mandir@
pkglibdir       = @pkglibdir@
pkgdatadir      = @pkgdatadir@
includedir      = ${prefix}/include

VPATH           = @srcdir@

# ------------------------------------------------
#   DEFINITIONS
# ------------------------------------------------

@WITH_MODULES_TRUE@MODULES_DIRS    = libltdl modules
SUBDIRS         = pcre lib $(MODULES_DIRS) src doc packages tests
SDP             =
MP4H_VERSION    = @VERSION@

SHELL           = /bin/sh
CC              = @CC@
CFLAGS          = @CFLAGS@
LDFLAGS         = @LDFLAGS@
LIBS            = @LIBS@
LIBTOOL         = @LIBTOOL@

#   installation tools
SHTOOL          = $(top_srcdir)/shtool
INSTALL_PROGRAM = $(SHTOOL) install -c -m 755
INSTALL_SCRIPT  = $(SHTOOL) install -c -m 755
INSTALL_DATA    = $(SHTOOL) install -c -m 644
MKDIR           = $(SHTOOL) mkdir -p -f -m 755
VERSION_TOOL    = $(SHTOOL) version
TARBALL         = $(SHTOOL) tarball -t
FIXPERM         = $(SHTOOL) fixperm
RM              = rm -f

# ------------------------------------------------
#   THE DEFAULT TARGETS
# ------------------------------------------------

all: mp4h-config all-recursive mp4h-config.1

# ------------------------------------------------
#   TEST SUITE
# ------------------------------------------------

RECURS_TARGET = \
   echo "===> $(SDP)$$dir ($$target)"; \
   (cd $$dir && $(MAKE) SDP="$(SDP)$$dir/" prefix=$(prefix) $$target) \
   || case "$$amf" in *=*) exit 1;; *k*) fail=yes;; *) exit 1;; esac; \
   echo "<=== $(SDP)$$dir"

RECURS_TARGET_NOBREAK = \
   echo "===> $(SDP)$$dir ($$target)"; \
   (cd $$dir && $(MAKE) SDP="$(SDP)$$dir/" $$target); \
   echo "<=== $(SDP)$$dir"

test: all
	@dir=tests; target='$@'; $(RECURS_TARGET_NOBREAK)

check: test

mp4h-config: mp4h-config.src
	sed -e '/^=head1/,/^=cut/d' \
        -e '/^__END__/,$$d' \
        -e 's|\@VERSION\@|$(MP4H_VERSION)|g' \
        -e 's|\@prefix\@|$(prefix)|g' \
        -e 's|\@pkglibdir\@|$(pkglibdir)|g' \
        -e 's|\@pkgdatadir\@|$(pkgdatadir)|g' \
        -e 's|\@mandir\@|$(mandir)|g' \
        -e 's|\@CC\@|$(CC)|g' \
        -e 's|\@CFLAGS\@|$(CFLAGS)|g' \
          < $? >$@ && chmod a+x $@

mp4h-config.1: mp4h-config.src
	cp $? mp4h-config.pod
	pod2man --section=1 --center="Web Tools" --release="Web Tools" \
            mp4h-config.pod |\
            sed -e 's|\@VERSION\@|$(MP4H_VERSION)|g' > $@
	rm -f mp4h-config.pod

# ------------------------------------------------
#   INSTALLATION
# ------------------------------------------------

install: all
	$(MKDIR) $(bindir) $(mandir)/man1 $(pkgdatadir)
	$(MKDIR) $(prefix)/include $(pkglibdir)
	$(INSTALL_PROGRAM) src/mp4h $(bindir)/mp4h
	$(INSTALL_SCRIPT) mp4h-config $(bindir)/mp4h-config
	$(INSTALL_DATA) mp4h-config.1 $(mandir)/man1/mp4h-config.1
	$(INSTALL_DATA) doc/mp4h.1 $(mandir)/man1/mp4h.1
	$(INSTALL_DATA) $(top_srcdir)/src/mp4h.h $(includedir)/mp4h.h
	@dir=packages; target='$@'; $(RECURS_TARGET)
	@WITH_MODULES_TRUE@@dir=modules; target='$@'; $(RECURS_TARGET)

# ------------------------------------------------
#   CLEANUP
# ------------------------------------------------

clean: clean-recursive
	-$(RM) mp4h-config mp4h-config.1 mp4h-config.pod

distclean: clean distclean-recursive
	-$(RM) Makefile
	-$(RM) config.cache config.log config.status config.h
	-$(RM) libtool

# ------------------------------------------------
#   RECURSIVE CALLS
# ------------------------------------------------

#   Some GNU components (especially libltdl) require mkinstalldirs
#   to do nothing with it, so it is discarded
all-recursive install-recursive:
	-@set -e; \
	set dummy $(MAKEFLAGS); amf=$$2; \
	target=`echo $@ | sed s/-recursive//`; \
	for dir in $(SUBDIRS); do \
	    if [ -f $$dir/Makefile ]; then \
	        $(RECURS_TARGET); \
	    else :; \
	    fi; \
	done && test -z "$$fail"

clean-recursive distclean-recursive:
	@target=`echo $@ | sed s/-recursive//`; \
	for dir in $(SUBDIRS) modules; do \
	    if [ -f $$dir/Makefile ]; then \
	        $(RECURS_TARGET_NOBREAK); \
	    else :; \
	    fi; \
	done

# ------------------------------------------------
#   THE CONFIGURATION SUPPORT
# ------------------------------------------------

configure: configure.in 
	$(RM) configure
	autoconf
	chmod 770 configure

shtool:
	shtoolize -o $@ install mkdir version echo fixperm tarball

# ------------------------------------------------
#   THE RELEASE STUFF
# ------------------------------------------------

FIND = find      # name of a GNU find
GZIP = gzip      # where to find GNU Zip
NAME = barbier   # name of maintainer who rolls the tarball

EXCLUDE_FILES = CVS .cvsignore .scvsrc core tags mp4h-*.tar.gz debian build-

NEWVERS = \
    $(VERSION_TOOL) -l c -n mp4h -p mp4h_ $$OPT src/version.c; \
    V=`$(VERSION_TOOL) -l c -d short src/version.c`; \
    sed -e "7s/version=.*\/>/version=$$V \/>/g" <doc/mp4h.mp4h >doc/mp4h.mp4h.n && mv doc/mp4h.mp4h.n doc/mp4h.mp4h; \
    V=`$(VERSION_TOOL) -l c -d long src/version.c`; \
    sed -e "s/Version .*(.*)/Version $$V/g" <README >README.n && mv README.n README

UPDATEVERS = \
    V=`$(VERSION_TOOL) -l c -d short src/version.c`; \
    $(VERSION_TOOL) -l c -n mp4h -p mp4h_ -s $$V src/version.c; \
    sed -e "7s/version=.*\/>/version=$$V \/>/g" <doc/mp4h.mp4h >doc/mp4h.mp4h.n && mv doc/mp4h.mp4h.n doc/mp4h.mp4h; \
    V=`$(VERSION_TOOL) -l c -d long src/version.c`; \
    sed -e "s/Version .*(.*)/Version $$V/g" <README >README.n && mv README.n README

_GETDISTINFO = \
    _version=`$(VERSION_TOOL) -l c -d short src/version.c`; \
    _date=`date '+%Y%m%d_%H%M'`;

_BUILDDIST = \
    _cwd=`pwd`; \
    x=`echo $(EXCLUDE_FILES) | sed -e 's/[ 	][ 	]*/,^/g'`; \
    y=`echo $(EXCLUDE_FILES) | sed -e 's;[ 	][ 	]*;,/;g'`; \
    echo "Creating tarball..."; \
    cd $(top_srcdir) && \
    $(TARBALL) -u $(NAME) -g mp4h -c '$(GZIP) --best' \
        -e ^$$x,/$$y \
        -o $${_tarball} .; \
    echo "Done"; \
    cd $$_cwd && ls -l $${_tarball}

manifest: distclean
	unset LC_ALL; x=`echo $(EXCLUDE_FILES) |\
	   sed -e 's;/;\\\\/;g' -e 's#[ 	]\{1,\}#/d -e /#g'`; \
	$(FIND) * -type f -depth -print |\
	sed -e /$$x/d | sort >MANIFEST

release: distclean manifest fixperm
	@$(_GETDISTINFO) \
    _distname="mp4h-$${_version}"; \
    _tarball="$${_distname}.tar.gz"; \
    echo "Release Distribution: mp4h Version $$_version"; \
    $(_BUILDDIST)

snap: distclean fixperm
	@$(_GETDISTINFO) \
    _distname="mp4h-$${_version}-SNAP"; \
    _tarball="$${_distname}.tar.gz"; \
    echo "Snap of whole source tree: mp4h Version $$_version as of $$_date"; \
    $(_BUILDDIST)

deb: release
	fakeroot ./debian/rules clean
	set -e; $(_GETDISTINFO) \
    mv mp4h-$${_version}.tar.gz ../mp4h_$${_version}.orig.tar.gz
	dpkg-buildpackage -i'/CVS|/\.cvsignore|/\.scvsrc|/tags' -rfakeroot

new-version:
	@V="$(VERSION)"; \
	if [ ".$$V" != . ]; then \
		OPT="-s$$V"; \
	else \
		OPT="-e"; \
	fi; \
	$(NEWVERS)

update-version:
	$(UPDATEVERS)

fixperm:
	$(FIXPERM) *

##EOF##
